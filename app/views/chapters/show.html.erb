<% crumbs_for @chapter %>

<div class="font-serif">
  <div class="max-w-prose mx-auto mb-4">
    <div class="text-lg">
      <%= link_to @story.creator.display_name, creator_path(@story.creator), class: "ts-link" %>
      : <%= link_to @story.title, story_path(@story), class: "ts-link" %>
    </div>
    <% if @chapter.title.present? || Current.user == @story.creator %>
      <div class="flex flex-row items-baseline">
        <h1 class="text-2xl"><%= @chapter.title.presence || 'Untitled' %></h1>
      </div>
    <% end %>
    <div class="mt-4 text-sm flex flex-row gap-1">
      <% cache [ @chapter, :word_count ] do %>
        <span>
          <%= number_to_delimited(@chapter.word_count) %> words
          (<%= distance_of_time_in_words(@chapter.time_to_read.minutes) %>)
        </span>
      <% end %>
      <% if @chapter.prior_chapter.present? %>
        <span>
          &mdash; Flip back to <%= link_to(@chapter.prior_chapter.title.presence || 'the previous chapter', @chapter.prior_chapter, class: 'ts-link') %>
        </span>
      <% end %>
      <% if Current.user == @story.creator %>
        <span class="ml-auto font-sans">
          [
            <%= link_to "Edit", edit_chapter_path(@chapter), class: "ts-link" %> |
            <%= form_with url: chapter_path(@chapter), method: :delete, data: { turbo_confirm: "Really delete this chapter?" }, class: "inline" do |f| %>
              <%= f.submit "Delete", class: "ts-cancel cursor-pointer" %>
            <% end %>
          ]
        </span>
      <% end %>
    </div>

    <hr class="my-6" />
  </div>

  <% cache @chapter do %>
    <%= render @chapter.sections %>
  <% end %>
</div>

<div class="max-w-prose mx-auto border-t border-dashed mt-4 pt-4">
  <% if !editable_story? && visible_sequels(@chapter).none? %>
    <div class="italic mb-4">That's all for now, but stay tuned! <%= @story.creator.display_name %> could post more at any time.</div>
  <% elsif visible_sequels(@chapter).any? %>
    <% if editable_story? %>
      <div>Your story continues with:</div>
    <% else %>
      <div>Don't go away! The story continues here:</div>
    <% end %>
    <ul class="ml-4 mt-2 mb-4">
      <% visible_sequels(@chapter).each do |action| %>
        <li>&rarr; <%= link_to action.prompt, chapter_path(action.target), class: "ts-link" %></li>
      <% end %>
    </ul>
  <% end %>

  <% if editable_story? %>
    <div class="mb-4">
      <% if @chapter.actions.any? %>
        Or, you can branch your story from here. <%= link_to "Write an alternative chapter.", new_chapter_sequel_path(@chapter), class: "ts-link" %>
      <% else %>
        Continue your story from here. <%= link_to "Add the next chapter.", new_chapter_sequel_path(@chapter), class: "ts-link" %>
      <% end %>
    </div>
  <% end %>

  <% if editable_story? %>
    <div data-controller="draft-list" data-draft-list-key-value="<%= dom_id(@chapter) %>" class="my-4">
      <h2 class="font-bold text-lg mb-4">Sequel Drafts</h2>

      <template data-draft-list-target="template">
        <li><%= link_to "", new_chapter_sequel_path(@chapter), class: "ts-link" %></li>
      </template>

      <ul data-draft-list-target="list" class="list-disc mt-2 ml-8">
      </ul>
    </div>
  <% end %>

  <div class="flex-col mb-16">
    <%= render 'comments/list', commentable: @chapter %>
  </div>
