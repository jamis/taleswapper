<% crumbs_for @story, leaf: false %>
<% breadcrumb 'New chapter' %>

<div class="flex-col w-full" data-controller="sequel" data-sequel-parent-value="<%= dom_id(@chapter || @story) %>" data-sequel-uuid-value="<%= @uuid %>">
  <h1 class="text-2xl font-bold">Game Time!</h1>
  <h2 class="text-md italic">
    <% if @chapter %>
      Play a new chapter. You're picking up from the end of <%= link_to @chapter.title, @chapter, class: 'ts-link' %>.
    <% else %>
      Play the first chapter of your story.
    <% end %>
  </h2>

  <%= form_with model: @chapter ? Chapter::Sequel.from_chapter(@chapter, @uuid) : Chapter::Sequel.from_scratch(@uuid), url: @chapter ? chapter_sequels_path(@chapter) : story_sequels_path(@story) do |form| %>
    <%= form.hidden_field :uuid %>

    <h2 class="text-lg font-bold mt-4">Session Notes</h2>
    <p class="text-sm italic">
      Keep notes on your game session here. Once you feel like you have enough
      to write the next chapter of your tale, click "Next."
    </p>

    <%= form.text_area :contents, class: 'focus:outline-none focus:ring-0 border rounded-lg w-full overflow-hidden resize-none font-mono text-sm px-4 py-2 mt-2', data: { controller: 'textarea-resize', textarea_resize_min_height_value: 288, sequel_target: 'field', action: 'textarea-resize#resize sequel#snapshot' } %>

    <%= dialog title: "Scratch Pad", start: :closed, color: :yellow, id: 'scratchPad' do %>
      <%= form.text_area :scratch_pad, class: "border-0 ring-0 focus:ring-0 resize-none w-full h-64 bg-yellow-50 text-sm font-mono", data: { sequel_target: 'field', action: 'sequel#snapshot' } %>
    <% end %>

    <%= dialog title: "Track Sheet", start: :closed, color: :blue, id: 'trackSheet' do %>
      <%= render TrackSheet.new(definition: @chapter.final_track_sheet) %>
    <% end %>

    <div class="text-sm mt-1">
      Your notes here are automatically saved. Return to this draft at any time to
      resume your work.
    </div>

    <div class="mt-4 mb-12">
      <button data-controller="trigger" data-trigger-dialog-outlet="#scratchPad" data-action="trigger#do:prevent" class="rounded bg-yellow-100 hover:bg-yellow-300 px-4 py-2">Story Notes</button>
      <button data-controller="trigger" data-trigger-dialog-outlet="#trackSheet" data-action="trigger#do:prevent" class="rounded bg-yellow-100 hover:bg-yellow-300 px-4 py-2">Track Sheet</button>
      <span class="px-2">|</span>
      <% if @chapter %>
        <%= link_to "Go back to #{@chapter.title}", chapter_path(@chapter), class: "inline-block px-4 py-2 bg-blue-100 rounded hover:bg-blue-300" %>
      <% else %>
        <%= link_to "Go back to the story", story_path(@story), class: "inline-block px-4 py-2 bg-blue-100 rounded hover:bg-blue-300" %>
      <% end %>
      <span class="px-2">|</span>
      <%= submit_tag "Next", class: "rounded bg-blue-100 hover:bg-blue-300 px-4 py-2" %>
      <span class="mx-1">or</span>
      <%= link_to "Discard this draft", @chapter ? chapter_path(@chapter) : story_path(@story), data: { action: 'sequel#discard' }, class: "ts-cancel" %>
    </div>
  <% end %>
</div>
